memory.limit(size = 7500000)
library(tableone)
library(lubridate)
library(tidyverse)
library(dplyr)
library(janitor)
library(plyr)
# get data -----------------------------------------------------------------
setwd(  "C:/Users/amykr/Box Sync/Amy Krystosik's Files/secure- u24 participants/data")
load("C:/Users/amykr/Box Sync/Amy Krystosik's Files/Data Managment/redcap/ro1 lab results long/R01_lab_results.clean.rda")
load("C:/Users/amykr/Box Sync/Amy Krystosik's Files/Data Managment/redcap/ro1 lab results long/aic_symptoms.rda")
load("C:/Users/amykr/Box Sync/Amy Krystosik's Files/secure- u24 participants/data/u24_results.rda")

AIC<- R01_lab_results
AIC <- merge(aic_symptoms, AIC, by=c("person_id", "redcap_event_name"), all = TRUE)  #merge symptoms to redcap data

#create acute variable
AIC$acute<-NA
AIC <- within(AIC, acute[AIC$visit_type==1] <- 1)
AIC <- within(AIC, acute[AIC$visit_type==2] <- 1)
AIC <- within(AIC, acute[AIC$visit_type==3] <- 0)
AIC <- within(AIC, acute[AIC$visit_type==4] <- 1)
AIC <- within(AIC, acute[AIC$visit_type==5] <- 0)

#if they ask an initial survey question (see odk aic inital and follow up forms), it is an initial visit.
AIC <- within(AIC, acute[!is.na(AIC$kid_highest_level_education_aic)] <- 1)
AIC <- within(AIC, acute[AIC$kid_highest_level_education_aic!=""] <- 1)

AIC <- within(AIC, acute[AIC$occupation_aic!=""] <- 1)
AIC <- within(AIC, acute[AIC$oth_educ_level_aic!=""] <- 1)
AIC <- within(AIC, acute[AIC$mom_highest_level_education_aic!=""] <- 1)
AIC <- within(AIC, acute[AIC$roof_type!=""] <- 1)
AIC <- within(AIC, acute[AIC$pregnant!=""] <- 1)
#if it is visit a,call it acute
AIC <- within(AIC, acute[AIC$redcap_event=="visit_a_arm_1" & id_cohort=="F"] <- 1)
#if they have fever, call it acute
AIC <- within(AIC, acute[AIC$aic_symptom_fever==1] <- 1)
table(AIC$aic_symptom_fever,exclude = NULL)
table(AIC$acute,exclude = NULL)
AIC <- within(AIC, acute[AIC$temp>=38] <- 1)
#otherwise, it is not acute
AIC <- within(AIC, acute[AIC$acute!=1 & !is.na(AIC$gender_aic) ] <- 0)

table(AIC$acute)

AIC$int_date <-ymd(AIC$interview_date_aic)

AIC_no_pedsql<-AIC[, !grepl("pedsql", names(AIC))]
names(AIC_no_pedsql)[names(AIC_no_pedsql) == 'redcap_event_name'] <- 'redcap_event'

# pedsql ------------------------------------------------------------------

pedsql <- AIC[, grepl("person_id|redcap_event|pedsql|acute|int_date", names(AIC) ) ]

pedsql<-as.data.frame(AIC[, grepl("person_id|redcap_event_name|pedsql", names(AIC))])

pedsql<-unique(pedsql)

#reverse scoring: Step 1: Transform Score. Items are reversed scored and linearly transformed to a 0-100 scale as follows: 0=100, 1=75, 2=50, 3=25, 4=0.
#remove missing
  pedsql[pedsql=="99" ] <- NA#refused
  pedsql[pedsql=="98" ] <- NA#other

pedsql[pedsql=="0" ] <- 100#there has never been a problem
pedsql[pedsql=="1" ] <- 75#almost no problems
pedsql[pedsql=="2" ] <- 50#sometimes there are problems
pedsql[pedsql=="3" ] <- 25#each time there is a problem
pedsql[pedsql=="4" ] <- 0#problems all the time

#children
#select child vars
pedsql_child<- pedsql[, grepl("person_id|redcap_event_name|pedsql", names(pedsql))]
pedsql_child<-pedsql_child[, !grepl("parent", names(pedsql_child))]

#total child score
pedsql_child_total<- pedsql_child[, grepl("person_id|redcap_event_name|walk|run|play|lift|work|fear|scared|angry|sad|agreement|rejected|bullied|understand|forget|schoolhomework", names(pedsql_child))]
pedsql_child_total$not_missing_child<-rowSums(!is.na(pedsql_child_total))
pedsql_child_total$not_missing_child<-pedsql_child_total$not_missing_child-2
table(pedsql_child_total$not_missing_child)
pedsql_child_total$pedsql_child_total_sum<-rowSums(pedsql_child_total[, grep("walk|run|play|lift|work|fear|scared|angry|sad|agreement|rejected|bullied|understand|forget|schoolhomework", names(pedsql_child_total))], na.rm = TRUE)
pedsql_child_total$pedsql_child_total_mean<-round(pedsql_child_total$pedsql_child_total_sum/pedsql_child_total$not_missing_child)

pedsql_child_total<- within(pedsql_child_total, pedsql_child_total_mean[pedsql_child_total$not_missing_child<(15/2)] <- NA)
hist(pedsql_child_total$pedsql_child_total_mean)
#merge back to database
pedsql_child_total<-pedsql_child_total[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_total))]
pedsql_child_total<-as.data.frame(pedsql_child_total)
pedsql_merge<-as.data.frame(pedsql)

pedsql_merge<-merge(pedsql_merge, pedsql_child_total)
hist(pedsql_child_total$pedsql_child_total_mean, breaks=110)

#physical vars
#Mean score = Sum of the items over the number of items answered
pedsql_child_physical<- pedsql_child[, grepl("person_id|redcap_event_name|walk|run|play|lift|work", names(pedsql_child))]
pedsql_child_physical<- pedsql_child_physical[, !grepl("school", names(pedsql_child_physical))]
pedsql_child_physical$not_missing_child_physical<-rowSums(!is.na(pedsql_child_physical))
pedsql_child_physical$not_missing_child_physical<-pedsql_child_physical$not_missing_child_physical-2
pedsql_child_physical$pedsql_child_physical_sum<-rowSums(pedsql_child_physical[, grep("walk|run|play|lift|work", names(pedsql_child_physical))], na.rm = TRUE)
pedsql_child_physical$pedsql_child_physical_mean<-round(pedsql_child_physical$pedsql_child_physical_sum/pedsql_child_physical$not_missing_child_physical)
pedsql_child_physical<- within(pedsql_child_physical, pedsql_child_physical_mean[pedsql_child_physical$not_missing_child_physical<2.5] <- NA)

hist(pedsql_child_physical$pedsql_child_physical_mean, breaks=110)
#merge back to database
pedsql_child_physical<-pedsql_child_physical[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_physical))]
pedsql_merge <- merge(pedsql_child_physical, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)

# emotion vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_child_emotional<- pedsql_child[, grepl("person_id|redcap_event_name|fear|scared|angry|sad", names(pedsql_child))]
pedsql_child_emotional$not_missing_child_emotional<-rowSums(!is.na(pedsql_child_emotional))
pedsql_child_emotional$not_missing_child_emotional<-pedsql_child_emotional$not_missing_child_emotional-2
pedsql_child_emotional$pedsql_child_emotional_sum<-rowSums(pedsql_child_emotional[, grep("fear|scared|angry|sad", names(pedsql_child_emotional))], na.rm = TRUE)
pedsql_child_emotional$pedsql_child_emotional_mean<-round(pedsql_child_emotional$pedsql_child_emotional_sum/pedsql_child_emotional$not_missing_child_emotional)
pedsql_child_emotional<- within(pedsql_child_emotional, pedsql_child_emotional_mean[pedsql_child_emotional$not_missing_child_emotional<1.5] <- NA)

hist(pedsql_child_emotional$pedsql_child_emotional_mean, breaks=110)
#merge back to database
pedsql_child_emotional<-pedsql_child_emotional[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_emotional))]
pedsql_merge <- merge(pedsql_child_emotional, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)

# social vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_child_social<- pedsql_child[, grepl("person_id|redcap_event_name|agreement|rejected|bullied", names(pedsql_child))]
pedsql_child_social$not_missing_child_social<-rowSums(!is.na(pedsql_child_social))
pedsql_child_social$not_missing_child_social<-pedsql_child_social$not_missing_child_social-2
pedsql_child_social$pedsql_child_social_sum<-rowSums(pedsql_child_social[, grep("agreement|rejected|bullied", names(pedsql_child_social))], na.rm = TRUE)
pedsql_child_social$pedsql_child_social_mean<-round(pedsql_child_social$pedsql_child_social_sum/pedsql_child_social$not_missing_child_social)
pedsql_child_social<- within(pedsql_child_social, pedsql_child_social_mean[pedsql_child_social$not_missing_child_social<1.5] <- NA)

hist(pedsql_child_social$pedsql_child_social_mean, breaks=110)
#merge back to database
pedsql_child_social<-pedsql_child_social[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_social))]
pedsql_merge <- merge(pedsql_child_social, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)

# school vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_child_school<- pedsql_child[, grepl("person_id|redcap_event_name|understand|forget|schoolhomework", names(pedsql_child))]
pedsql_child_school$not_missing_child_school<-rowSums(!is.na(pedsql_child_school))
pedsql_child_school$not_missing_child_school<-pedsql_child_school$not_missing_child_school-2
pedsql_child_school$pedsql_child_school_sum<-rowSums(pedsql_child_school[, grep("understand|forget|schoolhomework", names(pedsql_child_school))], na.rm = TRUE)
pedsql_child_school$pedsql_child_school_mean<-round(pedsql_child_school$pedsql_child_school_sum/pedsql_child_school$not_missing_child_school)
pedsql_child_school<- within(pedsql_child_school, pedsql_child_school_mean[pedsql_child_school$not_missing_child_school<1.5] <- NA)

hist(pedsql_child_school$pedsql_child_school_mean, breaks=110)
#merge back to database
pedsql_child_school<-pedsql_child_school[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_school))]
pedsql_merge <- merge(pedsql_child_school, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
# psychosocial vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_child_psych<- pedsql_child[, grepl("person_id|redcap_event_name|understand|forget|schoolhomework|agreement|rejected|bullied|fear|scared|angry|sad", names(pedsql_child))]
pedsql_child_psych$not_missing_child_psych<-rowSums(!is.na(pedsql_child_psych))
pedsql_child_psych$not_missing_child_psych<-pedsql_child_psych$not_missing_child_psych-2
pedsql_child_psych$pedsql_child_psych_sum<-rowSums(pedsql_child_psych[, grep("understand|forget|schoolhomework|agreement|rejected|bullied|fear|scared|angry|sad", names(pedsql_child_psych))], na.rm = TRUE)
pedsql_child_psych$pedsql_child_psych_mean<-round(pedsql_child_psych$pedsql_child_psych_sum/pedsql_child_psych$not_missing_child_psych)
pedsql_child_psych<- within(pedsql_child_psych, pedsql_child_psych_mean[pedsql_child_psych$not_missing_child_psych<5] <- NA)

hist(pedsql_child_psych$pedsql_child_psych_mean, breaks=110)
#merge back to database
pedsql_child_psych<-pedsql_child_psych[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_child_psych))]
pedsql_merge <- merge(pedsql_child_psych, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
# parents vars ------------------------------------------------------------
pedsql_parent<- pedsql[, grepl("person_id|redcap_event_name|_parent", names(pedsql))]
#total parent score
pedsql_parent_total<- pedsql_parent[, grepl("person_id|redcap_event_name|walk|run|play|lift|work|fear|scared|angry|sad|agreement|rejected|bullied|understand|forget|schoolhomework", names(pedsql_parent))]
pedsql_parent_total$not_missing_parent<-rowSums(!is.na(pedsql_parent_total))
pedsql_parent_total$not_missing_parent<-pedsql_parent_total$not_missing_parent-2
pedsql_parent_total$pedsql_parent_total_sum<-rowSums(pedsql_parent_total[, grep("walk|run|play|lift|work|fear|scared|angry|sad|agreement|rejected|bullied|understand|forget|schoolhomework", names(pedsql_parent_total))], na.rm = TRUE)
pedsql_parent_total$pedsql_parent_total_mean<-round(pedsql_parent_total$pedsql_parent_total_sum/pedsql_parent_total$not_missing_parent)
pedsql_parent_total<- within(pedsql_parent_total, pedsql_parent_total_mean[pedsql_parent_total$not_missing_parent<(15/2)] <- NA)

#merge back to database
pedsql_parent_total<-pedsql_parent_total[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_total))]
pedsql_merge <- merge(pedsql_parent_total, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
hist(pedsql_parent_total$pedsql_parent_total_mean, breaks = 110)
# physical vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_parent_physical<- pedsql_parent[, grepl("person_id|redcap_event_name|walk|run|play|lift|work", names(pedsql_parent))]
pedsql_parent_physical<- pedsql_parent_physical[, !grepl("school", names(pedsql_parent_physical))]
pedsql_parent_physical$not_missing_parent_physical<-rowSums(!is.na(pedsql_parent_physical))
pedsql_parent_physical$not_missing_parent_physical<-pedsql_parent_physical$not_missing_parent_physical-2
pedsql_parent_physical$pedsql_parent_physical_sum<-rowSums(pedsql_parent_physical[, grep("walk|run|play|lift|work", names(pedsql_parent_physical))], na.rm = TRUE)
pedsql_parent_physical$pedsql_parent_physical_mean<-round(pedsql_parent_physical$pedsql_parent_physical_sum/pedsql_parent_physical$not_missing_parent_physical)
pedsql_parent_physical<- within(pedsql_parent_physical, pedsql_parent_physical_mean[pedsql_parent_physical$not_missing_parent_physical<2.5] <- NA)

hist(pedsql_parent_physical$pedsql_parent_physical_mean, breaks=110)
#merge back to database
pedsql_parent_physical<-pedsql_parent_physical[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_physical))]
pedsql_merge <- merge(pedsql_parent_physical, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)


# emotional vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_parent_emotional<- pedsql_parent[, grepl("person_id|redcap_event_name|fear|scared|angry|sad", names(pedsql_parent))]
pedsql_parent_emotional$not_missing_parent_emotional<-rowSums(!is.na(pedsql_parent_emotional))
pedsql_parent_emotional$not_missing_parent_emotional<-pedsql_parent_emotional$not_missing_parent_emotional-2
pedsql_parent_emotional$pedsql_parent_emotional_sum<-rowSums(pedsql_parent_emotional[, grep("fear|scared|angry|sad", names(pedsql_parent_emotional))], na.rm = TRUE)
pedsql_parent_emotional$pedsql_parent_emotional_mean<-round(pedsql_parent_emotional$pedsql_parent_emotional_sum/pedsql_parent_emotional$not_missing_parent_emotional)
pedsql_parent_emotional<- within(pedsql_parent_emotional, pedsql_parent_emotional_mean[pedsql_parent_emotional$not_missing_parent_emotional<1.5] <- NA)

hist(pedsql_parent_emotional$pedsql_parent_emotional_mean, breaks=110)
#merge back to database
pedsql_parent_emotional<-pedsql_parent_emotional[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_emotional))]
pedsql_merge <- merge(pedsql_parent_emotional, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)

# social vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_parent_social<- pedsql_parent[, grepl("person_id|redcap_event_name|agreement|rejected|bullied", names(pedsql_parent))]
pedsql_parent_social$not_missing_parent_social<-rowSums(!is.na(pedsql_parent_social))
pedsql_parent_social$not_missing_parent_social<-pedsql_parent_social$not_missing_parent_social-2
pedsql_parent_social$pedsql_parent_social_sum<-rowSums(pedsql_parent_social[, grep("agreement|rejected|bullied", names(pedsql_parent_social))], na.rm = TRUE)
pedsql_parent_social$pedsql_parent_social_mean<-round(pedsql_parent_social$pedsql_parent_social_sum/pedsql_parent_social$not_missing_parent_social)
pedsql_parent_social<- within(pedsql_parent_social, pedsql_parent_social_mean[pedsql_parent_social$not_missing_parent_social<1.5] <- NA)

hist(pedsql_parent_social$pedsql_parent_social_mean, breaks=110)
#merge back to database
pedsql_parent_social<-pedsql_parent_social[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_social))]
pedsql_merge <- merge(pedsql_parent_social, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
# school vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_parent_school<- pedsql_parent[, grepl("person_id|redcap_event_name|understand|forget|schoolhomework", names(pedsql_parent))]
pedsql_parent_school$not_missing_parent_school<-rowSums(!is.na(pedsql_parent_school))
pedsql_parent_school$not_missing_parent_school<-pedsql_parent_school$not_missing_parent_school-2
pedsql_parent_school$pedsql_parent_school_sum<-rowSums(pedsql_parent_school[, grep("understand|forget|schoolhomework", names(pedsql_parent_school))], na.rm = TRUE)
pedsql_parent_school$pedsql_parent_school_mean<-round(pedsql_parent_school$pedsql_parent_school_sum/pedsql_parent_school$not_missing_parent_school)
pedsql_parent_school<- within(pedsql_parent_school, pedsql_parent_school_mean[pedsql_parent_school$not_missing_parent_school<1.5] <- NA)

hist(pedsql_parent_school$pedsql_parent_school_mean, breaks=110)
#merge back to database
pedsql_parent_school<-pedsql_parent_school[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_school))]
pedsql_merge <- merge(pedsql_parent_school, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
# psychosocial vars ------------------------------------------------------------
#Mean score = Sum of the items over the number of items answered
pedsql_parent_psych<- pedsql_parent[, grepl("person_id|redcap_event_name|understand|forget|schoolhomework|agreement|rejected|bullied|fear|scared|angry|sad", names(pedsql_parent))]
pedsql_parent_psych$not_missing_parent_psych<-rowSums(!is.na(pedsql_parent_psych))
pedsql_parent_psych$not_missing_parent_psych<-pedsql_parent_psych$not_missing_parent_psych-2
pedsql_parent_psych$pedsql_parent_psych_sum<-rowSums(pedsql_parent_psych[, grep("understand|forget|schoolhomework|agreement|rejected|bullied|fear|scared|angry|sad", names(pedsql_parent_psych))], na.rm = TRUE)
pedsql_parent_psych$pedsql_parent_psych_mean<-round(pedsql_parent_psych$pedsql_parent_psych_sum/pedsql_parent_psych$not_missing_parent_psych)
pedsql_parent_psych<- within(pedsql_parent_psych, pedsql_parent_psych_mean[pedsql_parent_psych$not_missing_parent_psych<5] <- NA)

hist(pedsql_parent_psych$pedsql_parent_psych_mean, breaks=110)
#merge back to database
pedsql_parent_psych<-pedsql_parent_psych[, grepl("person_id|redcap_event_name|mean|missing|sum", names(pedsql_parent_psych))]
pedsql_merge <- merge(pedsql_parent_psych, pedsql_merge,  by=c("person_id", "redcap_event_name"), all = TRUE)
# remove all missing collumns ------------------------------------------------------------
pedsql_merge <-pedsql_merge[!sapply(pedsql_merge, function (x) all(is.na(x) | x == ""| x == "NA"))]
pedsql_merge<-pedsql_merge[, !grepl("complete|comments", names(pedsql_merge))]
save(pedsql_merge,file="pedsql_merge.rda")
names(pedsql_merge)[names(pedsql_merge) == 'redcap_event_name'] <- 'redcap_event'

# merge back to aic data  ------------------------------------------------------------
AIC_no_pedsql <- AIC_no_pedsql[, grepl("person_id|redcap_event|acute|int_date", names(AIC_no_pedsql) ) ]
AIC_no_pedsql<-unique(AIC_no_pedsql)
pedsql_merge<-unique(pedsql_merge)
save(pedsql_merge,file="pedsql_merge.rda")
AIC <- merge(AIC_no_pedsql, pedsql_merge,  by=c("person_id", "redcap_event"), all = TRUE)

pedsql <- AIC[, grepl("person_id|redcap_event|pedsql|acute|int_date|strata_all", names(AIC) ) ]
save(pedsql,file="pedsql_all.rda")

# unpaired pedsql by strata -----------------------------------------------
#merge pedsql_all with david_coinfection_strata_hospitalization.rda      
load("C:/Users/amykr/Box Sync/Amy Krystosik's Files/david coinfectin paper/data/david_coinfection_strata_hospitalization.rda")
colnames(david_coinfection_strata_hospitalization)[colnames(david_coinfection_strata_hospitalization)=="redcap_event_name"] <- "redcap_event"
pedsql_all_coinfection <- join(pedsql, david_coinfection_strata_hospitalization,  by=c("person_id", "redcap_event"), match = "all" , type="full")
pedsql_all_coinfection$id<-paste(pedsql_all_coinfection$person_id, pedsql_all_coinfection$redcap_event, sep="_")
pedsql_all_coinfection<-pedsql_all_coinfection[,order(colnames(pedsql_all_coinfection))]
pedsql_all_coinfection<-pedsql_all_coinfection[order(-(grepl('outcome', names(pedsql_all_coinfection)))+1L)]
pedsql_all_coinfection<-pedsql_all_coinfection[order(-(grepl('strata', names(pedsql_all_coinfection)))+1L)]
pedsql_all_coinfection<-pedsql_all_coinfection[order(-(grepl('redcap', names(pedsql_all_coinfection)))+1L)]
pedsql_all_coinfection<-pedsql_all_coinfection[order(-(grepl('person_id', names(pedsql_all_coinfection)))+1L)]
# make david a table of unpaired data -------------------------------------
pedsqlvar<-grep("mean|sum", names(pedsql_all_coinfection), value = TRUE)
pedsql_paired_tableOne <- CreateTableOne(vars = pedsqlvar, strata = "strata", data = pedsql_all_coinfection)

pedsql_all_coinfection$strata_acute<-paste(pedsql_all_coinfection$strata, pedsql_all_coinfection$acute, sep="")
pedsql_all_coinfection<- within(pedsql_all_coinfection, strata_acute[strata_acute =="NA1"|strata_acute =="NA0"|strata_acute =="NANA"] <- NA)

pedsql_all_coinfection_acute<-pedsql_all_coinfection[which(pedsql_all_coinfection$acute==1)  , ]

pedsql_tableOne_unpaired_acute <- CreateTableOne(vars = pedsqlvar, , strata = "strata_all", data = pedsql_all_coinfection_acute,includeNA=T)

# #make pairs of acute and convalescent pedsql visits. #2 weeks -12 weeks  is a convalescent visit to pair with acute. --------
pedsql_wide<-reshape(pedsql, direction = "wide", idvar = "person_id", timevar = "redcap_event", sep = "_")
pedsql_wide$elapsed.time_patient_informatio_arm_1 <- NA
pedsql_wide$elapsed.time_visit_a_arm_1 <- NA
pedsql_wide$elapsed.time_visit_b_arm_1 <- as.numeric(pedsql_wide$int_date_visit_b_arm_1 - pedsql_wide$int_date_visit_a_arm_1)
pedsql_wide$elapsed.time_visit_c_arm_1 <- as.numeric(pedsql_wide$int_date_visit_c_arm_1 - pedsql_wide$int_date_visit_b_arm_1)
pedsql_wide$elapsed.time_visit_d_arm_1 <- as.numeric(pedsql_wide$int_date_visit_d_arm_1 - pedsql_wide$int_date_visit_c_arm_1)
pedsql_wide$elapsed.time_visit_e_arm_1 <- as.numeric(pedsql_wide$int_date_visit_e_arm_1 - pedsql_wide$int_date_visit_d_arm_1)
pedsql_wide$elapsed.time_visit_f_arm_1 <- as.numeric(pedsql_wide$int_date_visit_f_arm_1 - pedsql_wide$int_date_visit_e_arm_1)
pedsql_wide$elapsed.time_visit_g_arm_1 <- as.numeric(pedsql_wide$int_date_visit_g_arm_1 - pedsql_wide$int_date_visit_f_arm_1)
pedsql_wide$elapsed.time_visit_h_arm_1 <- as.numeric(pedsql_wide$int_date_visit_h_arm_1 - pedsql_wide$int_date_visit_g_arm_1)

pedsql_wide<-pedsql_wide[order(-(grepl('elapsed.time|int_date', names(pedsql_wide)))+1L)]

pedsql_wide$pairs_ab<-ifelse(pedsql_wide$elapsed.time_visit_b_arm_1>=14 & pedsql_wide$elapsed.time_visit_b_arm_1<=84 & pedsql_wide$acute_visit_a_arm_1 ==1 & !is.na(pedsql_wide$pedsql_date_visit_a_arm_1) & pedsql_wide$acute_visit_b_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_b_arm_1), 1, 0)    

pedsql_wide$pairs_bc<-ifelse(pedsql_wide$elapsed.time_visit_c_arm_1>=14 & pedsql_wide$elapsed.time_visit_c_arm_1<=84 & pedsql_wide$acute_visit_b_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_b_arm_1) & pedsql_wide$acute_visit_c_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_c_arm_1), 1, 0)    
pedsql_wide$pairs_cd<-ifelse(pedsql_wide$elapsed.time_visit_d_arm_1>=14 & pedsql_wide$elapsed.time_visit_d_arm_1<=84 & pedsql_wide$acute_visit_c_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_c_arm_1) & pedsql_wide$acute_visit_d_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_d_arm_1), 1, 0)    
pedsql_wide$pairs_de<-ifelse(pedsql_wide$elapsed.time_visit_e_arm_1>=14 & pedsql_wide$elapsed.time_visit_e_arm_1<=84 & pedsql_wide$acute_visit_d_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_d_arm_1) & pedsql_wide$acute_visit_e_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_e_arm_1), 1, 0)    
pedsql_wide$pairs_ef<-ifelse(pedsql_wide$elapsed.time_visit_f_arm_1>=14 & pedsql_wide$elapsed.time_visit_f_arm_1<=84 & pedsql_wide$acute_visit_e_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_e_arm_1) & pedsql_wide$acute_visit_f_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_f_arm_1), 1, 0)    
pedsql_wide$pairs_fg<-ifelse(pedsql_wide$elapsed.time_visit_g_arm_1>=14 & pedsql_wide$elapsed.time_visit_g_arm_1<=84 & pedsql_wide$acute_visit_f_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_f_arm_1) & pedsql_wide$acute_visit_g_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_g_arm_1), 1, 0)    
pedsql_wide$pairs_gh<-ifelse(pedsql_wide$elapsed.time_visit_h_arm_1>=14 & pedsql_wide$elapsed.time_visit_h_arm_1<=84 & pedsql_wide$acute_visit_g_arm_1==1 & !is.na(pedsql_wide$pedsql_date_visit_g_arm_1) & pedsql_wide$acute_visit_h_arm_1==0 & !is.na(pedsql_wide$pedsql_date_visit_h_arm_1), 1, 0)    

    negative_time<-pedsql_wide[which(pedsql_wide$elapsed.time_visit_b_arm_1<1|pedsql_wide$elapsed.time_visit_c_arm_1<1|pedsql_wide$elapsed.time_visit_d_arm_1<1|pedsql_wide$elapsed.time_visit_e_arm_1<1|pedsql_wide$elapsed.time_visit_f_arm_1<1|pedsql_wide$elapsed.time_visit_g_arm_1<1|pedsql_wide$elapsed.time_visit_h_arm_1<1),]
    write.csv(negative_time,"negative_time.csv")#cornelius is working on cleaning these up. 

#make var for acute and follow up measures at acute visit  based on acute. 
pedsql_pairs<- pedsql_wide[, grepl("person_id|pairs|mean|acute|elapsed.time|int_date", names(pedsql_wide) ) ]
pedsql_pairs<- pedsql_pairs[, !grepl("u24", names(pedsql_pairs))]
pedsql_pairs$pair_sum <- as.integer(rowSums(pedsql_pairs[ , grep("pairs" , names(pedsql_pairs))], na.rm =TRUE))

#remove acute and put in seperate data frame
acute<- as.data.frame(pedsql_pairs[, grepl("person_id|acute", names(pedsql_pairs) ) ])
pedsql_pairs<- pedsql_pairs[, !grepl("acute", names(pedsql_pairs) ) ]

# reshape to long ---------------------------------------------------------
pedsql_pairs<-pedsql_pairs[,order(colnames(pedsql_pairs))]

pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_h_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_g_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_f_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_e_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_d_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_c_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_b_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('visit_a_arm_1', names(pedsql_pairs)))+1L)]
pedsql_pairs<-pedsql_pairs[order(-(grepl('patient_informatio_arm_1', names(pedsql_pairs)))+1L)]

#reshape
v.names=c("elapsed.time","int_date","pedsql_child_emotional_mean", "pedsql_child_physical_mean","pedsql_child_psych_mean", "pedsql_child_school_mean", "pedsql_child_social_mean", "pedsql_child_total_mean", "pedsql_parent_emotional_mean", "pedsql_parent_physical_mean","pedsql_parent_psych_mean", "pedsql_parent_school_mean", "pedsql_parent_social_mean", "pedsql_parent_total_mean") 
times = c("patient_informatio_arm_1", "visit_a_arm_1", "visit_b_arm_1", "visit_c_arm_1", "visit_d_arm_1", "visit_e_arm_1", "visit_f_arm_1", "visit_g_arm_1", "visit_h_arm_1")
pedsql_pairs_long<-reshape(pedsql_pairs, idvar = "person_id", varying=c(1:126),  direction = "long", timevar = "redcap_event_name", times = times, v.names=v.names )

# #merge acute id's back to database -------------------------------------------------------------------
      acute_long<-reshape(acute, idvar = "person_id", varying=c(2:10),  direction = "long", timevar = "redcap_event_name", times =times, v.names="acute")
      pedsql_pairs_long <- merge(acute_long, pedsql_pairs_long,  by=c("person_id", "redcap_event_name"), all = TRUE)
      table(acute_long$acute)


      pedsql_pairs_long_ab<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_ab==1 & pedsql_pairs_long$redcap_event_name=="visit_a_arm_1")| (pedsql_pairs_long$pairs_ab==1 & pedsql_pairs_long$redcap_event_name=="visit_b_arm_1")),]
      pedsql_pairs_long_ab <- pedsql_pairs_long_ab[, grepl("person_id|redcap|mean|acute|_ab|elapsed.time", names(pedsql_pairs_long_ab) ) ]

      pedsql_pairs_long_bc<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_bc==1 & pedsql_pairs_long$redcap_event_name=="visit_b_arm_1")|(pedsql_pairs_long$pairs_bc==1 & pedsql_pairs_long$redcap_event_name=="visit_c_arm_1")),]
      pedsql_pairs_long_bc <- pedsql_pairs_long_bc[, grepl("person_id|redcap|mean|acute|_bc|elapsed.time", names(pedsql_pairs_long_bc) ) ]

      pedsql_pairs_long_cd<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_cd==1 & pedsql_pairs_long$redcap_event_name=="visit_c_arm_1")|(pedsql_pairs_long$pairs_cd==1 & pedsql_pairs_long$redcap_event_name=="visit_d_arm_1")),]
      pedsql_pairs_long_cd <- pedsql_pairs_long_cd[, grepl("person_id|redcap|mean|acute|_cd|elapsed.time", names(pedsql_pairs_long_cd ) ) ]

      pedsql_pairs_long_de<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_de==1 & pedsql_pairs_long$redcap_event_name=="visit_d_arm_1")|(pedsql_pairs_long$pairs_de==1 & pedsql_pairs_long$redcap_event_name=="visit_e_arm_1")),]
      pedsql_pairs_long_de <- pedsql_pairs_long_de[, grepl("person_id|redcap|mean|acute|_de|elapsed.time", names(pedsql_pairs_long_de ) ) ]

      pedsql_pairs_long_ef<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_ef==1 & pedsql_pairs_long$redcap_event_name=="visit_e_arm_1")|(pedsql_pairs_long$pairs_ef==1 & pedsql_pairs_long$redcap_event_name=="visit_f_arm_1")),]
      pedsql_pairs_long_ef <- pedsql_pairs_long_ef[, grepl("person_id|redcap|mean|acute|_ef|elapsed.time", names(pedsql_pairs_long_ef ) ) ]

      pedsql_pairs_long_fg<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_fg==1 & pedsql_pairs_long$redcap_event_name=="visit_f_arm_1")|(pedsql_pairs_long$pairs_fg==1 & pedsql_pairs_long$redcap_event_name=="visit_g_arm_1")),]
      pedsql_pairs_long_fg <- pedsql_pairs_long_fg[, grepl("person_id|redcap|mean|acute|_fg|elapsed.time", names(pedsql_pairs_long_fg ) ) ]

      pedsql_pairs_long_gh<-pedsql_pairs_long[which((pedsql_pairs_long$pairs_gh==1 & pedsql_pairs_long$redcap_event_name=="visit_g_arm_1")|(pedsql_pairs_long$pairs_gh==1 & pedsql_pairs_long$redcap_event_name=="visit_h_arm_1")),]
      pedsql_pairs_long_gh <- pedsql_pairs_long_gh[, grepl("person_id|redcap|mean|acute|_gh|elapsed.time", names(pedsql_pairs_long_gh ) ) ]

# pair the acute and conv data -------------------------------------------------------------
      pedsql_pairs_long_bind<-rbind.fill(pedsql_pairs_long_ab, pedsql_pairs_long_bc, pedsql_pairs_long_cd , pedsql_pairs_long_de, pedsql_pairs_long_ef, pedsql_pairs_long_fg, pedsql_pairs_long_gh)      
      #keep unique person ids and event names.> df[!duplicated(df[1:3]),]
        pedsql_pairs_long_bind<-pedsql_pairs_long_bind[!duplicated(pedsql_pairs_long_bind[1:2]), ]
        n_distinct(pedsql_pairs_long_bind$person_id, pedsql_pairs_long_bind$redcap_event_name)
        n_distinct(pedsql_pairs_long_bind$person_id)
        
#acute and convalescent
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, acute[acute ==1] <- "acute_paired")
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, acute[acute==0] <- "conv_paired")

#count repeat patients
      pedsql_pairs_long_bind$count<-with(pedsql_pairs_long_bind, ave(as.character(person_id), person_id, FUN = seq_along))
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, count[count==2] <- 1)
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, count[count==3] <- 2)
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, count[count==4] <- 2)
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, count[count==5] <- 3)
      pedsql_pairs_long_bind<- within(pedsql_pairs_long_bind, count[count==6] <- 3)
      table(pedsql_pairs_long_bind$count)
# pedsql total score at fu by time to fu. ---------------------------------
#cast to wide with acute and convalesent as the time
      pedsql_pairs_acute<-reshape(pedsql_pairs_long_bind, direction = "wide", idvar = c("person_id", "count"), timevar = "acute", sep = "_")
      
# change score Child ------------------------------------------------------------
      pedsql_pairs_acute$pedsql_child_total_mean_change<-pedsql_pairs_acute$pedsql_child_total_mean_conv_paired - pedsql_pairs_acute$pedsql_child_total_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_total_mean_z<-(pedsql_pairs_acute$pedsql_child_total_mean_change-mean(pedsql_pairs_acute$pedsql_child_total_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_total_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_child_school_mean_change<-pedsql_pairs_acute$pedsql_child_school_mean_conv_paired - pedsql_pairs_acute$pedsql_child_school_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_school_mean_z<-(pedsql_pairs_acute$pedsql_child_school_mean_change-mean(pedsql_pairs_acute$pedsql_child_school_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_school_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_child_social_mean_change<-pedsql_pairs_acute$pedsql_child_social_mean_conv_paired - pedsql_pairs_acute$pedsql_child_social_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_social_mean_z<-(pedsql_pairs_acute$pedsql_child_social_mean_change-mean(pedsql_pairs_acute$pedsql_child_social_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_social_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_child_physical_mean_change<-pedsql_pairs_acute$pedsql_child_physical_mean_conv_paired - pedsql_pairs_acute$pedsql_child_physical_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_physical_mean_z<-(pedsql_pairs_acute$pedsql_child_physical_mean_change-mean(pedsql_pairs_acute$pedsql_child_physical_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_physical_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_child_emotional_mean_change<-pedsql_pairs_acute$pedsql_child_emotional_mean_conv_paired - pedsql_pairs_acute$pedsql_child_emotional_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_emotional_mean_z<-(pedsql_pairs_acute$pedsql_child_emotional_mean_change-mean(pedsql_pairs_acute$pedsql_child_emotional_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_emotional_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_child_psych_mean_change<-pedsql_pairs_acute$pedsql_child_psych_mean_conv_paired - pedsql_pairs_acute$pedsql_child_psych_mean_acute_paired
      pedsql_pairs_acute$pedsql_child_psych_mean_z<-(pedsql_pairs_acute$pedsql_child_psych_mean_change-mean(pedsql_pairs_acute$pedsql_child_psych_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_child_psych_mean_change, na.rm = TRUE)

# change score parent ------------------------------------------------------------
      pedsql_pairs_acute$pedsql_parent_total_mean_change<-pedsql_pairs_acute$pedsql_parent_total_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_total_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_total_mean_z<-(pedsql_pairs_acute$pedsql_parent_total_mean_change-mean(pedsql_pairs_acute$pedsql_parent_total_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_total_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_parent_school_mean_change<-pedsql_pairs_acute$pedsql_parent_school_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_school_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_school_mean_z<-(pedsql_pairs_acute$pedsql_parent_school_mean_change-mean(pedsql_pairs_acute$pedsql_parent_school_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_school_mean_change, na.rm = TRUE)
 
      pedsql_pairs_acute$pedsql_parent_social_mean_change<-pedsql_pairs_acute$pedsql_parent_social_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_social_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_social_mean_z<-(pedsql_pairs_acute$pedsql_parent_social_mean_change-mean(pedsql_pairs_acute$pedsql_parent_social_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_social_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_parent_physical_mean_change<-pedsql_pairs_acute$pedsql_parent_physical_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_physical_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_physical_mean_z<-(pedsql_pairs_acute$pedsql_parent_physical_mean_change-mean(pedsql_pairs_acute$pedsql_parent_physical_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_physical_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_parent_emotional_mean_change<-pedsql_pairs_acute$pedsql_parent_emotional_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_emotional_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_emotional_mean_z<-(pedsql_pairs_acute$pedsql_parent_emotional_mean_change-mean(pedsql_pairs_acute$pedsql_parent_emotional_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_emotional_mean_change, na.rm = TRUE)

      pedsql_pairs_acute$pedsql_parent_psych_mean_change<-pedsql_pairs_acute$pedsql_parent_psych_mean_conv_paired - pedsql_pairs_acute$pedsql_parent_psych_mean_acute_paired
      pedsql_pairs_acute$pedsql_parent_psych_mean_z<-(pedsql_pairs_acute$pedsql_parent_psych_mean_change-mean(pedsql_pairs_acute$pedsql_parent_psych_mean_change, na.rm = TRUE))/sd(pedsql_pairs_acute$pedsql_parent_psych_mean_change, na.rm = TRUE)

      save(pedsql_pairs_acute,file="C:/Users/amykr/Box Sync/Amy Krystosik's Files/david coinfectin paper/data/pedsql_pairs_acute.rda")#save for use in others